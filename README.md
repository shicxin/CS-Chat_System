[toc]

# cs架构的聊天系统设计与实现思路

## 系统概述

cs架构的聊天系统是指客户端/服务器（C/S）的模式来设计的聊天软件；

客户端负责提供用户界面和发送接收消息。

服务器负责处理用户的请求，维护聊天记录，转发消息，保证消息的可靠性和安全性。

## 系统功能

cs架构的聊天系统需要实现以下基本功能：

-   用户注册和登录：用户可以通过输入用户名和密码来注册和登录系统，服务器需要验证用户的身份，并返回相应的结果（登录是否成功与注册的ID）。

-   用户管理：用户可以修改自己的个人资料，如昵称、签名等，也可以添加、删除、搜索好友，查看好友的在线状态等（未实现）。

-   消息通信：用户可以与其他用户进行单聊或群聊，发送和接收文本、图片、音频、视频等类型的消息，也可以撤回或删除已发送的消息（图片。音频视频未实现、撤回未实现）。

-   文件传输：用户可以在聊天中发送和接收各种类型的文件，如文档、压缩包、程序等，服务器需要对文件进行存储和转发（未实现）。

-   消息提醒：用户可以在收到新消息时收到通知或提示音，也可以设置免打扰模式或屏蔽某些用户或群组的消息（收到消息有显示，未添加声音，免打扰未实现）。

-   消息加密：用户可以选择对消息进行加密，以保护自己的隐私和安全，服务器需要支持不同的加密算法和协议。（未实现）

	

## 系统设计

-   数据设计(data design)
	-   数据传输设计(data transfer design)
		
		
		
		![image-20230814090649376](assets/image-20230814090649376.png)
	-   数据存储设计
		-   消息暂存
			
			![image-20230814090912638](assets/image-20230814090912638.png)
	
-   客户端设计：

	-   用户界面：设计用户友好的界面，包括消息列表、联系人列表、群组列表等，并提供聊天输入框和发送按钮。
	-   用户认证：实现用户注册、登录和身份验证机制，确保用户的安全性。
	-   消息传输：使用网络通信协议（如TCP/IP）与服务器通信，发送和接收消息；支持多种类型的消息，如文字、图片、音频和视频。
	-   消息存储和同步：将发送的消息存储在本地数据库中，并与服务器进行同步，以便在其他设备上能够获取到最新的消息记录。

-   服务器端设计：

	-   接收和处理消息：服务器接收来自客户端的消息，并处理发送给特定用户或群组的消息。
	-   用户管理：管理用户注册、登录、认证和权限控制。
	-   消息路由和转发：根据消息的目标用户或群组，将消息路由到相应的客户端。
	-   数据存储：将用户的个人信息、联系人列表、消息记录等存储在服务器端的数据库中。
	-   定期备份：定期备份服务器上的数据，以防止数据丢失或损坏。

-   消息传递

	-   数据结构（ `cjson` 与 `cjson`字符串）
	-   在线消息（客户端发给服务器，服务器发给需要发的客户端或暂存）
	-   离线消息（服务器等客户端上线后再告诉客户端谁发来了消息）
	-   广播消息（所有人都可以看到的消息）
	
	实现群组聊天：
	
	-   设计群组机制，允许用户创建、加入和管理群组。
	-   实现群组内的消息通信和同步，确保所有群组成员能收到相应的消息。
	

## 系统功能细分

1.  客户端设计：
	-   用户界面：设计用户友好的界面，包括消息列表、联系人列表、群组列表等，并提供聊天输入框和发送按钮。
	-   用户认证：实现用户注册、登录和身份验证机制，确保用户的安全性。
	-   消息传输：使用网络通信协议（如TCP/IP）与服务器通信，发送和接收消息；支持多种类型的消息，如文字、图片、音频和视频。
	-   消息存储和同步：将发送的消息存储在本地数据库中，并与服务器进行同步，以便在其他设备上能够获取到最新的消息记录。
	
2.  服务器端设计：
	-   接收和处理消息：服务器接收来自客户端的消息，并处理发送给特定用户或群组的消息。
	-   用户管理：管理用户注册、登录、认证和权限控制。
	-   消息路由和转发：根据消息的目标用户或群组，将消息路由到相应的客户端。
	-   数据存储：将用户的个人信息、联系人列表、消息记录等存储在服务器端的数据库中。
	-   定期备份：定期备份服务器上的数据，以防止数据丢失或损坏。（未实现、但是写了一个shell脚本用于备份）
	
3.  实现实时通信：
	-   使用Socket技术建立客户端与服务器之间的长连接，以实现实时消息传输。
	
4.  实现离线消息：
	-   当用户离线时，将离线期间收到的消息存储在服务器上，直到用户再次上线时进行同步。
	-   客户端在上线时，先检查服务器上是否有未读的离线消息，再进行同步。
	
6.  实现群组聊天：（暂时所有人在一个群组中）
	-   设计群组机制，允许用户创建、加入和管理群组。
	
	-   实现群组内的消息通信和同步，确保所有群组成员能收到相应的消息。
	
	    ![CS聊天室](assets/CS聊天室-1691976741230-1.png)

![CS聊天室](assets/CS聊天室.png)

## 系统实现

### server

1.   接听某个端口（等待客户端的命令）
2.   创建，删除用户
3.   用户维护（注册，登录，删除）
4.   接收用户发送的消息
5.   进程之间套接字传递
6.   向用户发送消息
7.   消息暂存

### client

1.   接听服务器消息
2.   注册以及登录
3.   消息监听
4.   消息发送



## 项目难点

1.   `json`对象的使用

2.   多进程管理同一用户链表

3.   进程之间文件描述符的发送与接收

     

